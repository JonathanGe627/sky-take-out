<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sky.mapper.OrderMapper">
    <insert id="insertOrder" useGeneratedKeys="true" keyProperty="id">
        insert into orders
            (number, status, user_id, address_book_id, order_time, checkout_time, pay_method, pay_status, amount, remark, phone, address, user_name, consignee, cancel_reason, rejection_reason, cancel_time, estimated_delivery_time, delivery_status, delivery_time, pack_amount, tableware_number, tableware_status)
        values
            (#{number}, #{status}, #{userId}, #{addressBookId}, #{orderTime}, #{checkoutTime}, #{payMethod}, #{payStatus}, #{amount}, #{remark}, #{phone}, #{address}, #{userName}, #{consignee}, #{cancelReason}, #{rejectionReason}, #{cancelTime}, #{estimatedDeliveryTime}, #{deliveryStatus}, #{deliveryTime}, #{packAmount}, #{tablewareNumber}, #{tablewareStatus})
    </insert>

    <update id="update" parameterType="com.sky.entity.Orders">
        update orders
        <set>
            <if test="cancelReason != null and cancelReason!='' ">
                cancel_reason=#{cancelReason},
            </if>
            <if test="rejectionReason != null and rejectionReason!='' ">
                rejection_reason=#{rejectionReason},
            </if>
            <if test="cancelTime != null">
                cancel_time=#{cancelTime},
            </if>
            <if test="payStatus != null">
                pay_status=#{payStatus},
            </if>
            <if test="payMethod != null">
                pay_method=#{payMethod},
            </if>
            <if test="checkoutTime != null">
                checkout_time=#{checkoutTime},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="deliveryTime != null">
                delivery_time = #{deliveryTime}
            </if>
        </set>
        where id = #{id}
    </update>

    <resultMap id="orderRM" type="com.sky.vo.OrderVO">
        <id column="id" property="id"></id>
        <result column="number" property="number"></result>
        <result column="status" property="status"></result>
        <result column="user_id" property="userId"></result>
        <result column="address_book_id" property="addressBookId"></result>
        <result column="order_time" property="orderTime"></result>
        <result column="checkout_time" property="checkoutTime"></result>
        <result column="pay_method" property="payMethod"></result>
        <result column="pay_status" property="payStatus"></result>
        <result column="amount" property="amount"></result>
        <result column="remark" property="remark"></result>
        <result column="user_name" property="userName"></result>
        <result column="phone" property="phone"></result>
        <result column="address" property="address"></result>
        <result column="consignee" property="consignee"></result>
        <result column="cancel_reason" property="cancelReason"></result>
        <result column="rejection_reason" property="rejectionReason"></result>
        <result column="cancel_time" property="cancelTime"></result>
        <result column="estimated_delivery_time" property="estimatedDeliveryTime"></result>
        <result column="delivery_status" property="deliveryStatus"></result>
        <result column="delivery_time" property="deliveryTime"></result>
        <result column="pack_amount" property="packAmount"></result>
        <result column="tableware_number" property="tablewareNumber"></result>
        <result column="tableware_status" property="tablewareStatus"></result>
        <collection property="orderDetailList" ofType="com.sky.entity.OrderDetail">
            <id column="od_id" property="id"></id>
            <result column="name" property="name"></result>
            <result column="order_id" property="orderId"></result>
            <result column="dish_id" property="dishId"></result>
            <result column="setmeal_id" property="setmealId"></result>
            <result column="dish_flavor" property="dishFlavor"></result>
            <result column="od_number" property="number"></result>
            <result column="od_amount" property="amount"></result>
            <result column="image" property="image"></result>
        </collection>
    </resultMap>
    <select id="getOrderVOById" resultMap="orderRM">
        select o.*, od.id od_id, od.name, od.image, od.order_id, od.dish_id, od.setmeal_id, od.dish_flavor, od.number od_number, od.amount od_amount
        from (
        select * from orders
        where user_id = #{userId} and id = #{id}
        ) o
        left join order_detail od
        on o.id = od.order_id
    </select>
    <select id="page" resultType="com.sky.entity.Orders">
        select * from orders
        <where>
            user_id = #{userId}
            <if test="status != null">
                and status = #{status}
            </if>
        </where>
        order by order_time desc
    </select>
    <select id="getOrderDetailsByOrderIdList" resultType="com.sky.entity.OrderDetail">
        select * from order_detail
        where order_id in
        <foreach collection="orderIdList" item="orderId" open="(" close=")" separator=",">
            #{orderId}
        </foreach>
    </select>
    <select id="conditionSearchOrder" resultType="com.sky.entity.Orders">
        select * from orders
        <where>
            <if test="number != null and number != ''">
                number = #{number}
            </if>
            <if test="phone != null and phone != ''">
                and phone = #{phone}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="beginTime != null">
                and order_time > #{beginTime}
            </if>
            <if test="endTime != null">
                and order_time &lt; #{endTime}
            </if>
        </where>
        order by order_time desc
    </select>
    <select id="statistics" resultType="com.sky.entity.Orders">
        select * from orders where status in
        <foreach collection="statusList" item="status" open="(" close=")" separator=",">
            #{status}
        </foreach>
    </select>
    <select id="getOrderDetails" resultMap="orderRM">
        select o.*, od.id od_id, od.name, od.image, od.order_id, od.dish_id, od.setmeal_id, od.dish_flavor, od.number od_number, od.amount od_amount
        from (
        select * from orders
        where id = #{id}
        ) o
        left join order_detail od
        on o.id = od.order_id
    </select>
    <select id="statisticsOrder" resultType="com.sky.dto.OrderStatisticsDTO">
        select DATE(order_time) order_date, SUM(amount) total_amount
        from orders
        <where>
            order_time between #{begin} and #{end}
            <if test="status != null">
                and status = #{status}
            </if>
        </where>
        group by DATE(order_time)
        order by order_date
    </select>
    <select id="getOrderCountList" resultType="java.lang.Integer">
        <foreach collection="dateList" item="date" separator="UNION ALL">
            select COUNT(id) from orders
            where order_time &gt;= #{date} AND order_time &lt; DATE_ADD(#{date}, INTERVAL 1 DAY)
            <if test="status != null">
                and status = #{status}
            </if>
        </foreach>
    </select>
    <select id="getTotalOrderCount" resultType="java.lang.Integer">
        select COUNT(id) from orders where order_time &gt;= #{begin} AND order_time &lt; #{end}
        <if test="status != null">
            and status = #{status}
        </if>
    </select>
    <select id="top10" resultType="com.sky.dto.SalesTop10StatisticsDTO">
        select od.name sale_name, SUM(od.number) sale_number
        from order_detail od
        left join orders o
        on od.order_id = o.id
        where o.status = 5
        and o.order_time &gt;= #{begin} AND o.order_time &lt; #{end}
        group by od.name
        order by sale_number desc
        limit 0, 10
    </select>
    <select id="sumByMap" resultType="java.lang.Double">
        select sum(amount) from orders
        <where>
            <if test="begin != null">
                and order_time &gt; #{begin}
            </if>
            <if test="end != null">
                and order_time &lt; #{end}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
        </where>
    </select>
    <select id="countByMap" resultType="java.lang.Integer">
        select count(id) from orders
        <where>
            <if test="begin != null">
                and order_time &gt; #{begin}
            </if>
            <if test="end != null">
                and order_time &lt; #{end}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
        </where>
    </select>
</mapper>